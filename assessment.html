<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>運動參與前評估暨篩檢量表</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Inter:wght@400;600&display=swap"
        rel="stylesheet" />

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Inter"', '"Noto Sans TC"', 'sans-serif'],
                    },
                    colors: {
                        primary: { 50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8' },
                        slate: { 850: '#1e293b' }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #f8fafc;
            -webkit-tap-highlight-color: transparent;
        }

        .form-input {
            display: block;
            width: 100%;
            height: 44px;
            border-radius: 0.5rem;
            border: 1px solid #cbd5e1;
            padding: 0 0.75rem;
            font-size: 0.95rem;
            transition: all 0.2s;
            color: #334155;
            background-color: #fff;
        }

        textarea.form-input {
            height: auto;
            padding: 0.75rem;
        }

        .form-input:focus {
            border-color: #3b82f6;
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        /* Custom Checkbox/Radio Cards */
        .check-card {
            cursor: pointer;
            position: relative;
        }

        .check-card input:checked+div {
            border-color: #3b82f6;
            background-color: #eff6ff;
            color: #1d4ed8;
        }

        /* Section transitions */
        details>summary {
            list-style: none;
        }

        details>summary::-webkit-details-marker {
            display: none;
        }
    </style>
</head>

<body class="text-slate-700 h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header
        class="bg-white border-b border-slate-200 h-16 flex-none z-30 shadow-sm flex items-center justify-between px-4 lg:px-8">
        <div class="flex items-center gap-3">
            <a href="index.html" class="bg-slate-100 hover:bg-slate-200 text-slate-600 p-2 rounded-lg transition-colors"
                title="回首頁">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                </svg>
            </a>
            <div class="bg-primary-600 text-white p-2 rounded-lg">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
            </div>
            <h1 class="text-lg font-bold text-slate-800 tracking-tight hidden sm:block">運動參與前評估暨篩檢量表</h1>
            <h1 class="text-lg font-bold text-slate-800 tracking-tight sm:hidden">運動評估</h1>
        </div>

        <!-- Tab Buttons (Pill Style) -->
        <div class="bg-slate-100 p-1 rounded-lg flex text-sm font-medium">
            <button onclick="switchTab('form')" id="tab-form"
                class="px-4 py-1.5 rounded-md transition-all shadow-sm bg-white text-primary-700">新增評估</button>
            <button onclick="switchTab('search')" id="tab-search"
                class="px-4 py-1.5 rounded-md transition-all text-slate-500 hover:text-slate-700">查詢紀錄</button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <!-- Sidebar Navigation (Desktop) -->
        <nav class="hidden lg:flex lg:flex-col w-64 bg-white border-r border-slate-200 overflow-y-auto">

            <!-- Section Navigation -->
            <div class="py-6 flex-1">
                <div class="px-4 mb-2 text-xs font-bold text-slate-400 uppercase tracking-wider">評估流程</div>
                <ul class="space-y-1">
                    <li><a href="#sec-basic"
                            class="block px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-50 hover:text-primary-600">1.
                            基本資料</a></li>
                    <li><a href="#sec-social"
                            class="block px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-50 hover:text-primary-600">2.
                            社會背景</a></li>
                    <li><a href="#sec-medical"
                            class="block px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-50 hover:text-primary-600">3.
                            醫療史</a></li>
                    <li><a href="#sec-history"
                            class="block px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-50 hover:text-primary-600">4.
                            手術與藥物</a></li>
                    <li><a href="#sec-activity"
                            class="block px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-50 hover:text-primary-600">5.
                            身體活動史</a></li>
                    <li><a href="#sec-personal"
                            class="block px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-50 hover:text-primary-600">6.
                            個人化考量</a></li>
                    <li><a href="#sec-cancer"
                            class="block px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-50 hover:text-primary-600">7.
                            癌症病史 (若有)</a></li>
                </ul>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto bg-slate-50 relative scroll-smooth" id="main-scroll">

            <!-- View: Form (New Assessment) -->
            <div id="view-form" class="max-w-4xl mx-auto p-4 pb-24 lg:p-8">
                <form id="assessmentForm" class="space-y-6" onsubmit="event.preventDefault()">

                    <!-- Section 1: Basic Info -->
                    <div id="sec-basic" class="bg-white rounded-xl shadow-sm border border-slate-200">
                        <div class="px-6 py-4 border-b border-slate-100 flex items-center justify-between">
                            <h2 class="font-bold text-slate-800 text-lg flex items-center">
                                <span
                                    class="bg-slate-800 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs mr-3">1</span>
                                基本資料
                            </h2>
                        </div>
                        <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="col-span-full md:col-span-1">
                                <label class="block text-sm font-semibold text-slate-700 mb-1">填寫日期</label>
                                <input type="date" name="date" class="form-input" required />
                            </div>
                            <div class="col-span-full md:col-span-1">
                                <label class="block text-sm font-semibold text-slate-700 mb-1">姓名</label>
                                <input type="text" name="name" class="form-input" placeholder="請輸入姓名" required />
                            </div>

                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-1">出生日期</label>
                                <input type="date" name="dob" class="form-input" required />
                            </div>

                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-1">性別</label>
                                <div class="flex gap-4">
                                    <label class="check-card flex-1">
                                        <input type="radio" name="gender" value="Male" class="sr-only">
                                        <div
                                            class="h-[44px] border rounded-lg flex items-center justify-center text-sm font-medium">
                                            男性</div>
                                    </label>
                                    <label class="check-card flex-1">
                                        <input type="radio" name="gender" value="Female" class="sr-only">
                                        <div
                                            class="h-[44px] border rounded-lg flex items-center justify-center text-sm font-medium">
                                            女性</div>
                                    </label>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-1">聯絡電話</label>
                                <input type="tel" name="phone" class="form-input" placeholder="09xx-xxx-xxx" />
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-1">聯絡地址</label>
                                <input type="text" name="address" class="form-input" placeholder="請輸入地址" />
                            </div>
                        </div>
                    </div>

                    <!-- Section 2: Social Background -->
                    <div id="sec-social" class="bg-white rounded-xl shadow-sm border border-slate-200">
                        <div class="px-6 py-4 border-b border-slate-100">
                            <h2 class="font-bold text-slate-800 text-lg flex items-center">
                                <span
                                    class="bg-slate-800 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs mr-3">2</span>
                                社會背景資料
                            </h2>
                        </div>
                        <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-1">工作狀態</label>
                                <input type="text" name="workStatus" class="form-input" />
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-1">婚姻狀況</label>
                                <input type="text" name="maritalStatus" class="form-input" />
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-1">飲酒量 (每週幾杯)</label>
                                <input type="text" name="alcohol" class="form-input" placeholder="例如: 2杯" />
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-1">抽菸狀況 (每日幾包)</label>
                                <input type="text" name="smoking" class="form-input" placeholder="例如: 0.5包" />
                            </div>

                            <div class="col-span-full">
                                <label class="block text-sm font-semibold text-slate-700 mb-3">當前活動量</label>
                                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                                    <label class="check-card">
                                        <input type="radio" name="currentActivityLevel" value="Sedentary"
                                            class="sr-only">
                                        <div class="border rounded-lg p-3 h-full hover:bg-slate-50 transition">
                                            <div class="font-bold text-slate-800 text-sm">久坐</div>
                                            <div class="text-xs text-slate-500 mt-1">幾乎不動</div>
                                        </div>
                                    </label>
                                    <label class="check-card">
                                        <input type="radio" name="currentActivityLevel" value="Light" class="sr-only">
                                        <div class="border rounded-lg p-3 h-full hover:bg-slate-50 transition">
                                            <div class="font-bold text-slate-800 text-sm">輕度活動</div>
                                            <div class="text-xs text-slate-500 mt-1">每週運動1-3天</div>
                                        </div>
                                    </label>
                                    <label class="check-card">
                                        <input type="radio" name="currentActivityLevel" value="Moderate"
                                            class="sr-only">
                                        <div class="border rounded-lg p-3 h-full hover:bg-slate-50 transition">
                                            <div class="font-bold text-slate-800 text-sm">中度活動</div>
                                            <div class="text-xs text-slate-500 mt-1">每週運動3-5天</div>
                                        </div>
                                    </label>
                                    <label class="check-card">
                                        <input type="radio" name="currentActivityLevel" value="High" class="sr-only">
                                        <div class="border rounded-lg p-3 h-full hover:bg-slate-50 transition">
                                            <div class="font-bold text-slate-800 text-sm">高度活動</div>
                                            <div class="text-xs text-slate-500 mt-1">每週運動6-7天</div>
                                        </div>
                                    </label>
                                    <label class="check-card sm:col-span-2 lg:col-span-1">
                                        <input type="radio" name="currentActivityLevel" value="VeryHigh"
                                            class="sr-only">
                                        <div class="border rounded-lg p-3 h-full hover:bg-slate-50 transition">
                                            <div class="font-bold text-slate-800 text-sm">非常高度活動</div>
                                            <div class="text-xs text-slate-500 mt-1">體力勞動或專業運動員</div>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section 3: Medical History -->
                    <div id="sec-medical" class="bg-white rounded-xl shadow-sm border border-slate-200">
                        <div class="px-6 py-4 border-b border-slate-100">
                            <h2 class="font-bold text-slate-800 text-lg flex items-center">
                                <span
                                    class="bg-slate-800 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs mr-3">3</span>
                                醫療史
                            </h2>
                        </div>
                        <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Row 1: 心血管問題 | 肌肉骨骼問題 -->
                            <div class="space-y-2">
                                <h3 class="font-bold text-primary-700 border-b pb-1 mb-2">心血管問題</h3>
                                <label class="flex items-center"><input type="checkbox" name="historyCardio"
                                        value="Hypertension"
                                        class="mr-2 rounded text-primary-600 focus:ring-primary-500">高血壓</label>
                                <label class="flex items-center"><input type="checkbox" name="historyCardio"
                                        value="Afib"
                                        class="mr-2 rounded text-primary-600 focus:ring-primary-500">心房顫動</label>
                                <label class="flex items-center"><input type="checkbox" name="historyCardio" value="DVT"
                                        class="mr-2 rounded text-primary-600 focus:ring-primary-500">深層靜脈栓塞</label>
                                <label class="flex items-center"><input type="checkbox" name="historyCardio"
                                        value="Angina"
                                        class="mr-2 rounded text-primary-600 focus:ring-primary-500">心絞痛</label>
                                <label class="flex items-center"><input type="checkbox" name="historyCardio" value="MI"
                                        class="mr-2 rounded text-primary-600 focus:ring-primary-500">心肌梗塞</label>
                                <label class="flex items-center"><input type="checkbox" name="historyCardio" value="CAD"
                                        class="mr-2 rounded text-primary-600 focus:ring-primary-500">冠狀動脈疾病</label>
                                <label class="flex items-center"><input type="checkbox" name="historyCardio"
                                        value="Valvular"
                                        class="mr-2 rounded text-primary-600 focus:ring-primary-500">心臟瓣膜疾病</label>
                                <label class="flex items-center"><input type="checkbox" name="historyCardio" value="PAD"
                                        class="mr-2 rounded text-primary-600 focus:ring-primary-500">周邊血管疾病</label>
                                <label class="flex items-center"><input type="checkbox" name="historyCardio"
                                        value="ImplantDevice"
                                        class="mr-2 rounded text-primary-600 focus:ring-primary-500">植入式心臟裝置</label>
                            </div>

                            <div class="space-y-2">
                                <h3 class="font-bold text-primary-700 border-b pb-1 mb-2">肌肉骨骼問題</h3>
                                <div class="flex items-center gap-2">
                                    <input type="checkbox" name="historyMuscle" value="Arthritis"
                                        class="rounded text-primary-600 focus:ring-primary-500">
                                    <span class="whitespace-nowrap">關節炎:</span>
                                    <input type="text" name="historyMuscle" data-prefix="Arthritis:"
                                        class="form-input h-8 py-1 flex-1" placeholder="部位/類型">
                                </div>
                                <div class="flex items-center gap-2">
                                    <input type="checkbox" name="historyMuscle" value="Pain"
                                        class="rounded text-primary-600 focus:ring-primary-500">
                                    <span class="whitespace-nowrap">肌肉/關節/骨頭疼痛:</span>
                                    <input type="text" name="historyMuscle" data-prefix="Pain:"
                                        class="form-input h-8 py-1 flex-1" placeholder="部位">
                                </div>
                                <label class="flex items-center"><input type="checkbox" name="historyMuscle"
                                        value="Osteoporosis"
                                        class="mr-2 rounded text-primary-600 focus:ring-primary-500">骨質疏鬆</label>
                                <label class="flex items-center"><input type="checkbox" name="historyMuscle"
                                        value="Gout"
                                        class="mr-2 rounded text-primary-600 focus:ring-primary-500">痛風</label>
                                <div class="flex items-center gap-2">
                                    <input type="checkbox" name="historyMuscle" value="Replacement"
                                        class="rounded text-primary-600 focus:ring-primary-500">
                                    <span class="whitespace-nowrap">關節置換:</span>
                                    <input type="text" name="historyMuscle" data-prefix="Replacement:"
                                        class="form-input h-8 py-1 flex-1" placeholder="部位">
                                </div>
                            </div>

                            <!-- Row 2: 代謝/血液問題 | 腎臟問題 -->
                            <div class="space-y-2">
                                <h3 class="font-bold text-primary-700 border-b pb-1 mb-2">代謝/血液問題</h3>
                                <label class="flex items-center"><input type="checkbox" name="historyMetabolic"
                                        value="DM1"
                                        class="mr-2 rounded text-primary-600 focus:ring-primary-500">第一型糖尿病</label>
                                <label class="flex items-center"><input type="checkbox" name="historyMetabolic"
                                        value="DM2"
                                        class="mr-2 rounded text-primary-600 focus:ring-primary-500">第二型糖尿病</label>
                                <label class="flex items-center"><input type="checkbox" name="historyMetabolic"
                                        value="Dyslipidemia"
                                        class="mr-2 rounded text-primary-600 focus:ring-primary-500">高血脂</label>
                                <label class="flex items-center"><input type="checkbox" name="historyMetabolic"
                                        value="MetabolicSyndrome"
                                        class="mr-2 rounded text-primary-600 focus:ring-primary-500">代謝症候群</label>
                                <label class="flex items-center"><input type="checkbox" name="historyMetabolic"
                                        value="FattyLiver"
                                        class="mr-2 rounded text-primary-600 focus:ring-primary-500">代謝性脂肪肝病</label>
                                <label class="flex items-center"><input type="checkbox" name="historyMetabolic"
                                        value="Thyroid"
                                        class="mr-2 rounded text-primary-600 focus:ring-primary-500">甲狀腺疾病</label>
                                <label class="flex items-center"><input type="checkbox" name="historyMetabolic"
                                        value="Anemia"
                                        class="mr-2 rounded text-primary-600 focus:ring-primary-500">貧血</label>
                                <label class="flex items-center"><input type="checkbox" name="historyMetabolic"
                                        value="BleedingDisorder"
                                        class="mr-2 rounded text-primary-600 focus:ring-primary-500">出血性疾病</label>
                            </div>

                            <div class="space-y-2">
                                <h3 class="font-bold text-primary-700 border-b pb-1 mb-2">腎臟問題</h3>
                                <label class="flex items-center"><input type="checkbox" name="historyKidney" value="CKD"
                                        class="mr-2 rounded text-primary-600 focus:ring-primary-500">慢性腎臟病</label>
                                <label class="flex items-center"><input type="checkbox" name="historyKidney"
                                        value="Hemodialysis"
                                        class="mr-2 rounded text-primary-600 focus:ring-primary-500">血液透析</label>
                                <label class="flex items-center"><input type="checkbox" name="historyKidney"
                                        value="PeritonealDialysis"
                                        class="mr-2 rounded text-primary-600 focus:ring-primary-500">腹膜透析</label>
                                <label class="flex items-center"><input type="checkbox" name="historyKidney"
                                        value="KidneyTransplant"
                                        class="mr-2 rounded text-primary-600 focus:ring-primary-500">腎臟移植</label>
                            </div>

                            <!-- Row 3: 呼吸問題 | 自體免疫疾病 -->
                            <div class="space-y-2">
                                <h3 class="font-bold text-primary-700 border-b pb-1 mb-2">呼吸問題</h3>
                                <label class="flex items-center"><input type="checkbox" name="historyRespiratory"
                                        value="Asthma"
                                        class="mr-2 rounded text-primary-600 focus:ring-primary-500">氣喘</label>
                                <label class="flex items-center"><input type="checkbox" name="historyRespiratory"
                                        value="COPD"
                                        class="mr-2 rounded text-primary-600 focus:ring-primary-500">慢性肺阻塞</label>
                            </div>

                            <div class="space-y-2">
                                <h3 class="font-bold text-primary-700 border-b pb-1 mb-2">自體免疫疾病</h3>
                                <div class="flex items-center gap-2">
                                    <input type="checkbox" name="historyAutoimmune_flag" value="Autoimmune"
                                        class="rounded text-primary-600 focus:ring-primary-500">
                                    <span class="whitespace-nowrap">自體免疫疾病:</span>
                                    <input type="text" name="historyAutoimmune" class="form-input h-8 py-1 flex-1"
                                        placeholder="疾病名稱">
                                </div>
                            </div>

                            <!-- Row 4: 神經系統問題 | 腸胃道問題 -->
                            <div class="space-y-2">
                                <h3 class="font-bold text-primary-700 border-b pb-1 mb-2">神經系統問題</h3>
                                <label class="flex items-center"><input type="checkbox" name="historyNeuro"
                                        value="Stroke"
                                        class="mr-2 rounded text-primary-600 focus:ring-primary-500">中風</label>
                                <label class="flex items-center"><input type="checkbox" name="historyNeuro" value="TBI"
                                        class="mr-2 rounded text-primary-600 focus:ring-primary-500">創傷性腦損傷</label>
                                <label class="flex items-center"><input type="checkbox" name="historyNeuro" value="SCI"
                                        class="mr-2 rounded text-primary-600 focus:ring-primary-500">脊隨損傷</label>
                                <label class="flex items-center"><input type="checkbox" name="historyNeuro"
                                        value="Headache"
                                        class="mr-2 rounded text-primary-600 focus:ring-primary-500">頭痛</label>
                                <label class="flex items-center"><input type="checkbox" name="historyNeuro"
                                        value="Seizure"
                                        class="mr-2 rounded text-primary-600 focus:ring-primary-500">癲癇</label>
                                <label class="flex items-center"><input type="checkbox" name="historyNeuro"
                                        value="Dementia"
                                        class="mr-2 rounded text-primary-600 focus:ring-primary-500">失智症</label>
                            </div>

                            <div class="space-y-2">
                                <h3 class="font-bold text-primary-700 border-b pb-1 mb-2">腸胃道問題</h3>
                                <label class="flex items-center"><input type="checkbox" name="historyGastro"
                                        value="GERD"
                                        class="mr-2 rounded text-primary-600 focus:ring-primary-500">腸胃道逆流</label>
                            </div>

                            <!-- Row 5: 其他 (spans full width) -->
                            <div class="md:col-span-2 space-y-2">
                                <h3 class="font-bold text-primary-700 border-b pb-1 mb-2">其他</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="space-y-2">
                                        <label class="flex items-center"><input type="checkbox" name="historyOtherPsych"
                                                value="AnxietyDepression"
                                                class="mr-2 rounded text-primary-600 focus:ring-primary-500">焦慮/憂鬱</label>
                                        <div class="flex items-center gap-2">
                                            <input type="checkbox" name="historyOtherPsych" value="OtherPsych"
                                                class="rounded text-primary-600 focus:ring-primary-500">
                                            <span class="whitespace-nowrap">其他精神疾病:</span>
                                            <input type="text" name="historyOtherPsychText" data-prefix="OtherPsych:"
                                                class="form-input h-8 py-1 flex-1" placeholder="疾病名稱">
                                        </div>
                                        <label class="flex items-center"><input type="checkbox" name="historyOtherSleep"
                                                value="SleepApnea"
                                                class="mr-2 rounded text-primary-600 focus:ring-primary-500">睡眠呼吸中止症</label>
                                    </div>
                                    <div>
                                        <label class="flex items-center p-2 bg-red-50 rounded border border-red-100">
                                            <input type="checkbox" name="historyCancerFlag" value="Yes"
                                                class="mr-2 rounded text-red-600 focus:ring-red-500"
                                                onchange="toggleCancerSection(this.checked)">
                                            <span class="font-bold text-red-700">惡性腫瘤 (癌症) - 若勾選請填寫第 7 部分</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section 4: History Texts -->
                    <div id="sec-history" class="bg-white rounded-xl shadow-sm border border-slate-200">
                        <div class="px-6 py-4 border-b border-slate-100">
                            <h2 class="font-bold text-slate-800 text-lg flex items-center">
                                <span
                                    class="bg-slate-800 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs mr-3">4</span>
                                手術、藥物與過敏史
                            </h2>
                        </div>
                        <div class="p-6 space-y-4">
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-1">過去手術紀錄史 (含日期)</label>
                                <textarea name="surgeryHistory" class="form-input" rows="3"
                                    placeholder="例如: 闌尾炎切除 (2010)"></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-1">目前所有藥物 (名稱/劑量/頻率)</label>
                                <textarea name="medicationHistory" class="form-input" rows="3"
                                    placeholder="例如: Aspirin 100mg QD"></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-1">已知藥物/食物過敏史</label>
                                <textarea name="allergyHistory" class="form-input" rows="2"
                                    placeholder="無，或描述過敏源"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Section 5: Activity History -->
                    <div id="sec-activity" class="bg-white rounded-xl shadow-sm border border-slate-200">
                        <div class="px-6 py-4 border-b border-slate-100">
                            <h2 class="font-bold text-slate-800 text-lg flex items-center">
                                <span
                                    class="bg-slate-800 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs mr-3">5</span>
                                身體活動史
                            </h2>
                        </div>
                        <div class="p-6 space-y-6">
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-3">診斷前的活動量</label>
                                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                                    <label class="check-card">
                                        <input type="radio" name="preDxActivityLevel" value="Sedentary" class="sr-only">
                                        <div class="border rounded-lg p-3 h-full hover:bg-slate-50 transition">
                                            <div class="font-bold text-slate-800 text-sm">久坐</div>
                                            <div class="text-xs text-slate-500 mt-1">幾乎不動</div>
                                        </div>
                                    </label>
                                    <label class="check-card">
                                        <input type="radio" name="preDxActivityLevel" value="Light" class="sr-only">
                                        <div class="border rounded-lg p-3 h-full hover:bg-slate-50 transition">
                                            <div class="font-bold text-slate-800 text-sm">輕度活動</div>
                                            <div class="text-xs text-slate-500 mt-1">每週運動1-3天</div>
                                        </div>
                                    </label>
                                    <label class="check-card">
                                        <input type="radio" name="preDxActivityLevel" value="Moderate" class="sr-only">
                                        <div class="border rounded-lg p-3 h-full hover:bg-slate-50 transition">
                                            <div class="font-bold text-slate-800 text-sm">中度活動</div>
                                            <div class="text-xs text-slate-500 mt-1">每週運動3-5天</div>
                                        </div>
                                    </label>
                                    <label class="check-card">
                                        <input type="radio" name="preDxActivityLevel" value="High" class="sr-only">
                                        <div class="border rounded-lg p-3 h-full hover:bg-slate-50 transition">
                                            <div class="font-bold text-slate-800 text-sm">高度活動</div>
                                            <div class="text-xs text-slate-500 mt-1">每週運動6-7天</div>
                                        </div>
                                    </label>
                                    <label class="check-card sm:col-span-2 lg:col-span-1">
                                        <input type="radio" name="preDxActivityLevel" value="VeryHigh" class="sr-only">
                                        <div class="border rounded-lg p-3 h-full hover:bg-slate-50 transition">
                                            <div class="font-bold text-slate-800 text-sm">非常高度活動</div>
                                            <div class="text-xs text-slate-500 mt-1">體力勞動或專業運動員</div>
                                        </div>
                                    </label>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-semibold text-slate-700 mb-1">偏好運動型態</label>
                                    <textarea name="preferredExercise" class="form-input" rows="3"></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-slate-700 mb-1">使用設備</label>
                                    <textarea name="equipment" class="form-input" rows="3"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section 6: Personal Considerations -->
                    <div id="sec-personal" class="bg-white rounded-xl shadow-sm border border-slate-200">
                        <div class="px-6 py-4 border-b border-slate-100">
                            <h2 class="font-bold text-slate-800 text-lg flex items-center">
                                <span
                                    class="bg-slate-800 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs mr-3">6</span>
                                個人化考量
                            </h2>
                        </div>
                        <div class="p-6 space-y-6">
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-1">參與者目標</label>
                                <textarea name="goals" class="form-input" rows="3"></textarea>
                            </div>

                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">運動限制或擔憂</label>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                    <label class="flex items-center"><input type="checkbox" name="limitations"
                                            value="None" class="mr-2">無特別限制</label>
                                    <label class="flex items-center"><input type="checkbox" name="limitations"
                                            value="Time" class="mr-2">時間限制</label>
                                    <label class="flex items-center"><input type="checkbox" name="limitations"
                                            value="Motivation" class="mr-2">缺乏動機</label>
                                    <label class="flex items-center"><input type="checkbox" name="limitations"
                                            value="Pain" class="mr-2">疼痛問題</label>
                                    <label class="flex items-center"><input type="checkbox" name="limitations"
                                            value="InjuryHistory" class="mr-2">運動傷害史</label>
                                    <label class="flex items-center"><input type="checkbox" name="limitations"
                                            value="Dyspnea" class="mr-2">呼吸困難</label>
                                    <label class="flex items-center"><input type="checkbox" name="limitations"
                                            value="NoEquipment" class="mr-2">缺乏設備</label>
                                    <div class="flex items-center gap-1 col-span-2 md:col-span-4 w-full">
                                        <span class="whitespace-nowrap">其他:</span>
                                        <input type="text" name="limitations" data-prefix="Other:"
                                            class="form-input h-7 py-0 text-sm flex-1">
                                    </div>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-1">其他 (陪伴者/支持系統)</label>
                                <textarea name="otherSupport" class="form-input" rows="2"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Section 7: Cancer History (Initially Hidden or at bottom) -->
                    <div id="sec-cancer" class="bg-red-50 rounded-xl shadow-sm border border-red-200 hidden">
                        <div class="px-6 py-4 border-b border-red-100">
                            <h2 class="font-bold text-red-800 text-lg flex items-center">
                                <span
                                    class="bg-red-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs mr-3">7</span>
                                癌症病史詳細資料
                            </h2>
                            <p class="text-xs text-red-500 mt-1">請填寫此區塊若您有癌症病史</p>
                        </div>

                        <div class="p-6 space-y-6">
                            <!-- Diagnosis -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold text-slate-700 mb-1">癌症種類</label>
                                    <input type="text" name="cancerType" class="form-input" />
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-slate-700 mb-1">癌症位置</label>
                                    <input type="text" name="cancerLocation" class="form-input" />
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-slate-700 mb-1">診斷日期</label>
                                    <input type="date" name="cancerDxDate" class="form-input" />
                                </div>
                                <div class="md:col-span-3">
                                    <label class="block text-sm font-semibold text-slate-700 mb-1">是否有轉移</label>
                                    <input type="text" name="metastasis" class="form-input" placeholder="若有，請列出部位" />
                                </div>
                            </div>

                            <!-- Treatment Status -->
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">治療狀態</label>
                                <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                                    <label class="check-card">
                                        <input type="radio" name="treatmentStatus" value="ActiveSurveillance"
                                            class="sr-only">
                                        <div
                                            class="border rounded-lg p-3 text-center hover:bg-red-50 transition h-full flex items-center justify-center">
                                            <span class="text-sm font-medium">追蹤中</span>
                                        </div>
                                    </label>
                                    <label class="check-card">
                                        <input type="radio" name="treatmentStatus" value="OnTreatment" class="sr-only">
                                        <div
                                            class="border rounded-lg p-3 text-center hover:bg-red-50 transition h-full flex items-center justify-center">
                                            <span class="text-sm font-medium">治療中</span>
                                        </div>
                                    </label>
                                    <label class="check-card">
                                        <input type="radio" name="treatmentStatus" value="Completed" class="sr-only">
                                        <div
                                            class="border rounded-lg p-3 text-center hover:bg-red-50 transition h-full flex items-center justify-center">
                                            <span class="text-sm font-medium">已完成治療</span>
                                        </div>
                                    </label>
                                </div>
                            </div>

                            <!-- Treatment Details -->
                            <div class="space-y-4 border-t border-red-200 pt-4">
                                <h3 class="font-bold text-red-700">已接受之治療</h3>

                                <!-- Surgery -->
                                <div class="bg-white p-3 rounded border border-red-100">
                                    <label class="font-semibold block mb-2">手術</label>
                                    <div class="grid grid-cols-2 gap-2">
                                        <input type="text" name="txSurgery_type" class="form-input text-sm"
                                            placeholder="手術種類">
                                        <input type="date" name="txSurgery_date" class="form-input text-sm">
                                    </div>
                                </div>

                                <!-- Chemo -->
                                <div class="bg-white p-3 rounded border border-red-100">
                                    <label class="font-semibold block mb-2">化學治療</label>
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-2 items-end">
                                        <div>
                                            <div class="mb-1 text-xs text-slate-500">藥物種類</div>
                                            <input type="text" name="txChemo_drug" class="form-input text-sm">
                                        </div>
                                        <div>
                                            <div class="mb-1 text-xs text-slate-500">日期/次數</div>
                                            <input type="text" name="txChemo_date" class="form-input text-sm">
                                        </div>
                                        <div>
                                            <div class="mb-1 text-xs text-slate-500">造成心臟毒性?</div>
                                            <div class="flex gap-3 items-center h-[44px]">
                                                <label class="inline-flex items-center cursor-pointer">
                                                    <input type="radio" name="txChemo_toxicity" value="No"
                                                        class="w-4 h-4 text-slate-600 focus:ring-slate-500" checked>
                                                    <span class="ml-1 text-sm">否</span>
                                                </label>
                                                <label class="inline-flex items-center cursor-pointer">
                                                    <input type="radio" name="txChemo_toxicity" value="Yes"
                                                        class="w-4 h-4 text-red-600 focus:ring-red-500">
                                                    <span class="ml-1 text-sm text-red-700 font-medium">是</span>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Radio -->
                                <div class="bg-white p-3 rounded border border-red-100">
                                    <label class="font-semibold block mb-2">放射治療</label>
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-2 items-end">
                                        <div>
                                            <div class="mb-1 text-xs text-slate-500">放療種類</div>
                                            <input type="text" name="txRadio_type" class="form-input text-sm">
                                        </div>
                                        <div>
                                            <div class="mb-1 text-xs text-slate-500">日期/次數</div>
                                            <input type="text" name="txRadio_date" class="form-input text-sm">
                                        </div>
                                        <div>
                                            <div class="mb-1 text-xs text-slate-500">造成心臟毒性?</div>
                                            <div class="flex gap-3 items-center h-[44px]">
                                                <label class="inline-flex items-center cursor-pointer">
                                                    <input type="radio" name="txRadio_toxicity" value="No"
                                                        class="w-4 h-4 text-slate-600 focus:ring-slate-500" checked>
                                                    <span class="ml-1 text-sm">否</span>
                                                </label>
                                                <label class="inline-flex items-center cursor-pointer">
                                                    <input type="radio" name="txRadio_toxicity" value="Yes"
                                                        class="w-4 h-4 text-red-600 focus:ring-red-500">
                                                    <span class="ml-1 text-sm text-red-700 font-medium">是</span>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Hormone -->
                                <div class="bg-white p-3 rounded border border-red-100">
                                    <label class="font-semibold block mb-2">賀爾蒙治療</label>
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-2 items-end">
                                        <div>
                                            <div class="mb-1 text-xs text-slate-500">藥物種類</div>
                                            <input type="text" name="txHormone_drug" class="form-input text-sm">
                                        </div>
                                        <div>
                                            <div class="mb-1 text-xs text-slate-500">日期/次數</div>
                                            <input type="text" name="txHormone_date" class="form-input text-sm">
                                        </div>
                                        <div>
                                            <div class="mb-1 text-xs text-slate-500">造成心臟毒性?</div>
                                            <div class="flex gap-3 items-center h-[44px]">
                                                <label class="inline-flex items-center cursor-pointer">
                                                    <input type="radio" name="txHormone_toxicity" value="No"
                                                        class="w-4 h-4 text-slate-600 focus:ring-slate-500" checked>
                                                    <span class="ml-1 text-sm">否</span>
                                                </label>
                                                <label class="inline-flex items-center cursor-pointer">
                                                    <input type="radio" name="txHormone_toxicity" value="Yes"
                                                        class="w-4 h-4 text-red-600 focus:ring-red-500">
                                                    <span class="ml-1 text-sm text-red-700 font-medium">是</span>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Target -->
                                <div class="bg-white p-3 rounded border border-red-100">
                                    <label class="font-semibold block mb-2">標靶治療</label>
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-2 items-end">
                                        <div>
                                            <div class="mb-1 text-xs text-slate-500">藥物種類</div>
                                            <input type="text" name="txTarget_drug" class="form-input text-sm">
                                        </div>
                                        <div>
                                            <div class="mb-1 text-xs text-slate-500">日期/次數</div>
                                            <input type="text" name="txTarget_date" class="form-input text-sm">
                                        </div>
                                        <div>
                                            <div class="mb-1 text-xs text-slate-500">造成心臟毒性?</div>
                                            <div class="flex gap-3 items-center h-[44px]">
                                                <label class="inline-flex items-center cursor-pointer">
                                                    <input type="radio" name="txTarget_toxicity" value="No"
                                                        class="w-4 h-4 text-slate-600 focus:ring-slate-500" checked>
                                                    <span class="ml-1 text-sm">否</span>
                                                </label>
                                                <label class="inline-flex items-center cursor-pointer">
                                                    <input type="radio" name="txTarget_toxicity" value="Yes"
                                                        class="w-4 h-4 text-red-600 focus:ring-red-500">
                                                    <span class="ml-1 text-sm text-red-700 font-medium">是</span>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Immuno -->
                                <div class="bg-white p-3 rounded border border-red-100">
                                    <label class="font-semibold block mb-2">免疫治療</label>
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-2 items-end">
                                        <div>
                                            <div class="mb-1 text-xs text-slate-500">藥物種類</div>
                                            <input type="text" name="txImmuno_drug" class="form-input text-sm">
                                        </div>
                                        <div>
                                            <div class="mb-1 text-xs text-slate-500">日期/次數</div>
                                            <input type="text" name="txImmuno_date" class="form-input text-sm">
                                        </div>
                                        <div>
                                            <div class="mb-1 text-xs text-slate-500">造成心臟毒性?</div>
                                            <div class="flex gap-3 items-center h-[44px]">
                                                <label class="inline-flex items-center cursor-pointer">
                                                    <input type="radio" name="txImmuno_toxicity" value="No"
                                                        class="w-4 h-4 text-slate-600 focus:ring-slate-500" checked>
                                                    <span class="ml-1 text-sm">否</span>
                                                </label>
                                                <label class="inline-flex items-center cursor-pointer">
                                                    <input type="radio" name="txImmuno_toxicity" value="Yes"
                                                        class="w-4 h-4 text-red-600 focus:ring-red-500">
                                                    <span class="ml-1 text-sm text-red-700 font-medium">是</span>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Issues Checklist -->
                            <div class="border-t border-red-200 pt-4">
                                <h3 class="font-bold text-red-700 mb-3">癌症相關問題</h3>
                                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 text-sm">
                                    <label class="flex items-center"><input type="checkbox" name="cancerIssues"
                                            value="Pain" class="mr-2">疼痛</label>
                                    <label class="flex items-center"><input type="checkbox" name="cancerIssues"
                                            value="Fatigue" class="mr-2">疲勞</label>
                                    <label class="flex items-center"><input type="checkbox" name="cancerIssues"
                                            value="Dyspnea" class="mr-2">容易喘</label>
                                    <label class="flex items-center"><input type="checkbox" name="cancerIssues"
                                            value="Numbness" class="mr-2">麻木/感覺異常</label>
                                    <label class="flex items-center"><input type="checkbox" name="cancerIssues"
                                            value="Weakness" class="mr-2">虛弱</label>
                                    <label class="flex items-center"><input type="checkbox" name="cancerIssues"
                                            value="Balance" class="mr-2">平衡問題</label>
                                    <label class="flex items-center"><input type="checkbox" name="cancerIssues"
                                            value="Depression" class="mr-2">憂鬱</label>
                                    <label class="flex items-center"><input type="checkbox" name="cancerIssues"
                                            value="Anxiety" class="mr-2">焦慮</label>
                                    <label class="flex items-center"><input type="checkbox" name="cancerIssues"
                                            value="Nausea" class="mr-2">噁心</label>
                                    <label class="flex items-center"><input type="checkbox" name="cancerIssues"
                                            value="WeightChange" class="mr-2">體重改變</label>
                                    <label class="flex items-center"><input type="checkbox" name="cancerIssues"
                                            value="TasteChange" class="mr-2">味覺改變</label>
                                    <label class="flex items-center"><input type="checkbox" name="cancerIssues"
                                            value="AppetiteLoss" class="mr-2">食慾不振</label>
                                    <label class="flex items-center"><input type="checkbox" name="cancerIssues"
                                            value="Constipation" class="mr-2">便祕</label>
                                    <label class="flex items-center"><input type="checkbox" name="cancerIssues"
                                            value="Diarrhea" class="mr-2">腹瀉</label>
                                    <label class="flex items-center"><input type="checkbox" name="cancerIssues"
                                            value="Lymphedema" class="mr-2">淋巴水腫</label>
                                    <label class="flex items-center"><input type="checkbox" name="cancerIssues"
                                            value="Cognitive" class="mr-2">認知功能改變</label>
                                    <label class="flex items-center"><input type="checkbox" name="cancerIssues"
                                            value="Vision" class="mr-2">視力改變</label>
                                    <label class="flex items-center"><input type="checkbox" name="cancerIssues"
                                            value="Hearing" class="mr-2">聽力改變</label>
                                    <label class="flex items-center col-span-2"><input type="checkbox"
                                            name="cancerIssues" value="BowelBladder" class="mr-2">腸道或膀胱功能異常</label>
                                    <div class="flex items-center gap-1 col-span-2 md:col-span-4 w-full">
                                        <span class="whitespace-nowrap">其他:</span>
                                        <input type="text" name="cancerIssues" data-prefix="Other:"
                                            class="form-input h-7 py-0 text-sm flex-1">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </form>
            </div>

            <!-- View: Search Records -->
            <div id="view-search" class="hidden max-w-4xl mx-auto p-4 lg:p-8">
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                    <h2 class="text-xl font-bold text-slate-800 mb-4">查詢紀錄</h2>
                    <div class="flex gap-2 mb-6">
                        <div class="relative flex-1">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <svg class="h-5 w-5 text-slate-400" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                </svg>
                            </div>
                            <input type="text" id="searchInput"
                                class="w-full pl-10 pr-4 py-3 rounded-lg border border-slate-300 focus:border-primary-500 focus:ring-2 focus:ring-primary-200 transition"
                                placeholder="輸入姓名、電話、出生日期或評估日期..." onkeydown="if(event.key==='Enter') searchData()" />
                        </div>
                        <button onclick="searchData()"
                            class="bg-primary-600 text-white px-6 rounded-lg font-bold hover:bg-primary-700 transition shadow-sm">查詢</button>
                    </div>
                    <div id="searchResults" class="space-y-3">
                        <div
                            class="text-center text-slate-400 py-12 bg-slate-50 rounded-lg border border-dashed border-slate-200">
                            請輸入關鍵字進行查詢
                        </div>
                    </div>
                </div>
            </div>

        </main>

        <div id="fab-container" class="fixed bottom-6 right-6 z-40 transition-transform duration-300 flex gap-2">
            <button onclick="cancelEdit()" id="cancelEditBtn"
                class="hidden bg-slate-500 text-white shadow-lg hover:shadow-xl hover:bg-slate-600 rounded-full px-4 py-4 flex items-center gap-2 font-bold transition-all active:scale-95">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
                <span>取消編輯</span>
            </button>
            <button onclick="submitForm()" id="submitBtn"
                class="bg-slate-800 text-white shadow-lg hover:shadow-xl hover:bg-slate-900 rounded-full px-6 py-4 flex items-center gap-2 font-bold transition-all active:scale-95">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                </svg>
                <span>提交紀錄</span>
            </button>
        </div>
    </div>

    <!-- Read-Only View Modal -->
    <div id="viewRecordPanel" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-hidden flex flex-col">
            <div class="sticky top-0 bg-white border-b px-6 py-4 flex justify-between items-center flex-none">
                <h2 class="text-xl font-bold text-slate-800">患者資料檢視</h2>
                <div class="flex gap-2">
                    <button onclick="printRecord()"
                        class="bg-slate-100 hover:bg-slate-200 text-slate-700 px-4 py-2 rounded-lg font-medium transition flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                        </svg>
                        列印
                    </button>
                    <button onclick="enterEditMode()"
                        class="bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg font-medium transition">
                        <span class="flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                            </svg>
                            編輯
                        </span>
                    </button>
                    <button onclick="closeViewPanel()"
                        class="bg-slate-200 hover:bg-slate-300 text-slate-700 px-4 py-2 rounded-lg font-medium transition">關閉</button>
                </div>
            </div>
            <div id="viewRecordContent" class="p-6 overflow-y-auto flex-1">
                <!-- Content will be populated dynamically -->
            </div>
        </div>
    </div>

    <script>
        // Google Sheet Web App URL
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz5v9DOLVSjipU1VjeEfXoZxTu0yiTw1l4wBFSZ1iZrbFdGv1XeYdfXCaMP3dH5ZxwP/exec';

        // ========== Edit Mode State ==========
        let currentRowId = null; // null = new record, number = editing existing

        function toggleCancerSection(show) {
            const sec = document.getElementById('sec-cancer');
            if (show) {
                sec.classList.remove('hidden');
                setTimeout(() => sec.scrollIntoView({ behavior: 'smooth' }), 100);
            } else {
                sec.classList.add('hidden');
            }
        }

        // ========== Tab Switch Functions ==========
        function switchTab(tab) {
            const tabForm = document.getElementById('tab-form');
            const tabSearch = document.getElementById('tab-search');
            const viewForm = document.getElementById('view-form');
            const viewSearch = document.getElementById('view-search');
            const fabContainer = document.getElementById('fab-container');

            if (tab === 'form') {
                tabForm.classList.add('bg-white', 'shadow-sm', 'text-primary-700');
                tabForm.classList.remove('text-slate-500');
                tabSearch.classList.remove('bg-white', 'shadow-sm', 'text-primary-700');
                tabSearch.classList.add('text-slate-500');

                viewForm.classList.remove('hidden');
                viewSearch.classList.add('hidden');
                if (fabContainer) fabContainer.classList.remove('hidden');
            } else {
                tabSearch.classList.add('bg-white', 'shadow-sm', 'text-primary-700');
                tabSearch.classList.remove('text-slate-500');
                tabForm.classList.remove('bg-white', 'shadow-sm', 'text-primary-700');
                tabForm.classList.add('text-slate-500');

                viewSearch.classList.remove('hidden');
                viewForm.classList.add('hidden');
                if (fabContainer) fabContainer.classList.add('hidden');
            }
        }

        // ========== Search Functions (for Search Page) ==========
        async function searchData() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) {
                Swal.fire('提示', '請輸入搜尋關鍵字', 'info');
                return;
            }

            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = '<div class="text-center py-8"><svg class="animate-spin h-8 w-8 text-primary-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></div>';

            try {
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=search&query=${encodeURIComponent(query)}`);
                const data = await response.json();

                if (data && data.result === 'success') {
                    renderSearchResults(data.data);
                } else {
                    resultsDiv.innerHTML = '<div class="text-center text-red-500 py-8">查詢失敗</div>';
                }
            } catch (error) {
                console.error(error);
                resultsDiv.innerHTML = '<div class="text-center text-red-500 py-8">發生錯誤</div>';
            }
        }

        function renderSearchResults(data) {
            const resultsDiv = document.getElementById('searchResults');
            if (!data || data.length === 0) {
                resultsDiv.innerHTML = '<div class="text-center text-slate-400 py-8 bg-slate-50 rounded">找不到資料</div>';
                return;
            }

            const fmtGender = (g) => g === 'Male' ? '男' : g === 'Female' ? '女' : '-';

            // Format date to YYYY-MM-DD only
            const fmtDate = (dateStr) => {
                if (!dateStr) return '-';
                // If already in YYYY-MM-DD format
                if (typeof dateStr === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
                    return dateStr;
                }
                // Try to parse and format
                const d = new Date(dateStr);
                if (!isNaN(d.getTime())) {
                    const year = d.getFullYear();
                    const month = String(d.getMonth() + 1).padStart(2, '0');
                    const day = String(d.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                }
                return '-';
            };

            // Calculate age from DOB
            const calcAge = (dobStr) => {
                if (!dobStr) return '-';
                const dob = new Date(dobStr);
                if (isNaN(dob.getTime())) return '-';
                const today = new Date();
                let age = today.getFullYear() - dob.getFullYear();
                const monthDiff = today.getMonth() - dob.getMonth();
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < dob.getDate())) {
                    age--;
                }
                return age;
            };

            resultsDiv.innerHTML = data.map((item) => `
                <div class="bg-white p-5 rounded-xl border border-slate-200 hover:border-primary-400 cursor-pointer transition-all shadow-sm hover:shadow-md group relative"
                     onclick="loadRecord('${item.rowId}')">
                    
                    <div class="absolute top-4 right-4 flex flex-col items-end gap-2 z-10">
                        <div class="flex gap-1">
                            <button type="button" class="text-slate-400 hover:text-green-600 p-1 rounded hover:bg-green-50 transition" title="編輯"
                                onclick="event.stopPropagation(); editPatient('${item.rowId}')">
                                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                </svg>
                            </button>
                            <button type="button" class="text-slate-400 hover:text-primary-600 p-1 rounded hover:bg-primary-50 transition" title="列印"
                                onclick="event.stopPropagation(); printPatient('${item.rowId}')">
                                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                                </svg>
                            </button>
                        </div>
                    </div>

                    <div class="flex flex-col gap-3 pr-24">
                        <div class="flex items-baseline gap-2">
                             <h3 class="font-bold text-slate-800 text-lg leading-tight">${item.name || '未命名'}</h3>
                             <span class="text-slate-600 text-sm">(${fmtGender(item.gender)}, ${calcAge(item.dob)}歲)</span>
                        </div>

                        <div class="flex flex-col gap-1 text-sm text-slate-600">
                            <div class="flex items-center gap-2">
                                <span class="text-slate-400">評估日期:</span>
                                <span class="font-mono font-medium text-slate-800">${fmtDate(item.date)}</span>
                            </div>
                             <div class="flex items-center gap-2">
                                <span class="text-slate-400">生日:</span>
                                <span class="font-mono text-slate-600">${fmtDate(item.dob)}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Edit patient from search results
        async function editPatient(rowId) {
            await loadRecord(rowId);
            enterEditMode();
        }

        // Print patient from search results  
        async function printPatient(rowId) {
            if (!currentRecordData || currentRecordData.rowId != rowId) {
                await loadRecord(rowId);
            }
            printRecord();
        }

        // Cancel edit mode
        function cancelEdit() {
            Swal.fire({
                title: '確定取消編輯？',
                text: '所有未儲存的修改將會遺失',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#64748b',
                confirmButtonText: '確定取消',
                cancelButtonText: '繼續編輯'
            }).then((result) => {
                if (result.isConfirmed) {
                    currentRowId = null;
                    currentRecordData = null;
                    document.getElementById('assessmentForm').reset();
                    // Reset custom fields if any
                    document.getElementById('fatigueValue').innerText = '0';
                    document.getElementById('meta-desc').classList.add('hidden');

                    updateSubmitButton();
                    Swal.fire({ icon: 'success', title: '已取消編輯', timer: 1500, showConfirmButton: false });
                }
            });
        }

        // Store current record data for view/edit
        let currentRecordData = null;

        function loadRecord(rowId) {
            return new Promise((resolve, reject) => {
                Swal.fire({ title: '載入中...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

                fetch(`${GOOGLE_SCRIPT_URL}?action=getRecord&rowId=${rowId}`)
                    .then(res => res.json())
                    .then(response => {
                        Swal.close();
                        if (response.result === 'success') {
                            currentRecordData = response.data;
                            currentRecordData.rowId = rowId; // Store rowId for reference
                            currentRowId = rowId;
                            showViewPanel(response.data);
                            resolve(response.data);
                        } else {
                            Swal.fire('Error', response.message || '無法載入記錄', 'error');
                            reject(new Error(response.message || '無法載入記錄'));
                        }
                    })
                    .catch(err => {
                        Swal.close();
                        console.error(err);
                        Swal.fire('Error', '載入失敗', 'error');
                        reject(err);
                    });
            });
        }

        // Medical history value to Chinese translation
        const medicalTranslations = {
            // 心血管問題
            'Hypertension': '高血壓', 'Afib': '心房顫動', 'DVT': '深層靜脈栓塞',
            'Angina': '心絞痛', 'MI': '心肌梗塞', 'CAD': '冠狀動脈疾病',
            'Valvular': '心臟瓣膜疾病', 'PAD': '周邊血管疾病', 'ImplantDevice': '植入式心臟裝置',
            // 肌肉骨骼問題
            'Arthritis': '關節炎', 'Pain': '肌肉/關節/骨頭疼痛', 'Osteoporosis': '骨質疏鬆',
            'Gout': '痛風', 'Replacement': '關節置換',
            // 代謝/血液問題
            'DM1': '第一型糖尿病', 'DM2': '第二型糖尿病', 'Dyslipidemia': '高血脂',
            'MetabolicSyndrome': '代謝症候群', 'FattyLiver': '代謝性脂肪肝病',
            'Thyroid': '甲狀腺疾病', 'Anemia': '貧血', 'BleedingDisorder': '出血性疾病',
            // 腎臟問題
            'CKD': '慢性腎臟病', 'Hemodialysis': '血液透析',
            'PeritonealDialysis': '腹膜透析', 'KidneyTransplant': '腎臟移植',
            // 呼吸問題
            'Asthma': '氣喘', 'COPD': '慢性肺阻塞',
            // 神經系統問題
            'Stroke': '中風', 'TBI': '創傷性腦損傷', 'SCI': '脊隨損傷',
            'Headache': '頭痛', 'Seizure': '癲癇', 'Dementia': '失智症',
            // 腸胃道問題
            'GERD': '腸胃道逆流',
            // 其他
            'AnxietyDepression': '焦慮/憂鬱', 'OtherPsych': '其他精神疾病',
            'SleepApnea': '睡眠呼吸中止症'
        };

        // Translate comma-separated values to Chinese
        function translateMedical(values) {
            if (!values) return '-';
            return values.split(',').map(v => {
                const trimmed = v.trim();
                // Handle values with colons (e.g., "Arthritis:左膝")
                if (trimmed.includes(':')) {
                    const [key, detail] = trimmed.split(':');
                    const translated = medicalTranslations[key] || key;
                    return `${translated}:${detail}`;
                }
                return medicalTranslations[trimmed] || trimmed;
            }).join(', ');
        }

        // Format date for display (YYYY-MM-DD only)
        function formatDateDisplay(dateStr) {
            if (!dateStr) return '-';

            // If already in YYYY-MM-DD format
            if (typeof dateStr === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
                return dateStr;
            }

            // Try to parse as Date object
            let d;
            if (dateStr instanceof Date) {
                d = dateStr;
            } else {
                d = new Date(dateStr);
            }

            // Check if valid date
            if (!isNaN(d.getTime())) {
                const year = d.getFullYear();
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            return '-';
        }

        function showViewPanel(data) {
            const panel = document.getElementById('viewRecordPanel');
            const content = document.getElementById('viewRecordContent');

            const fmtDate = formatDateDisplay;
            const fmtGender = (g) => g === 'Male' ? '男' : g === 'Female' ? '女' : '-';
            const fmtActivity = (l) => ({
                'Sedentary': '久坐', 'Light': '輕度活動', 'Moderate': '中度活動',
                'High': '高度活動', 'VeryHigh': '非常高度活動'
            })[l] || l || '-';
            const fmtTxStatus = (s) => ({
                'PreTreatment': '治療前', 'OnTreatment': '治療中', 'PostTreatment': '治療後'
            })[s] || s || '-';

            content.innerHTML = `
                <div class="space-y-4 text-sm">
                    <!-- Section 1: Basic Info -->
                    <div class="border rounded-lg p-4">
                        <h3 class="font-bold text-primary-700 mb-3 border-b pb-2">1. 基本資料</h3>
                        <div class="grid grid-cols-2 gap-2">
                            <div><b>填寫日期:</b> ${fmtDate(data.date)}</div>
                            <div><b>姓名:</b> ${data.name || '-'}</div>
                            <div><b>性別:</b> ${fmtGender(data.gender)}</div>
                            <div><b>出生日期:</b> ${fmtDate(data.dob)}</div>
                            <div><b>電話:</b> ${data.phone || '-'}</div>
                            <div><b>地址:</b> ${data.address || '-'}</div>
                        </div>
                    </div>
                    
                    <!-- Section 2: Social Background -->
                    <div class="border rounded-lg p-4">
                        <h3 class="font-bold text-primary-700 mb-3 border-b pb-2">2. 社會背景</h3>
                        <div class="grid grid-cols-2 gap-2">
                            <div><b>工作狀態:</b> ${data.workStatus || '-'}</div>
                            <div><b>婚姻狀況:</b> ${data.maritalStatus || '-'}</div>
                            <div><b>飲酒:</b> ${data.alcohol || '-'}</div>
                            <div><b>抽煙:</b> ${data.smoking || '-'}</div>
                            <div class="col-span-2"><b>當前活動量:</b> ${fmtActivity(data.currentActivityLevel)}</div>
                        </div>
                    </div>
                    
                    <!-- Section 3: Medical History -->
                    <div class="border rounded-lg p-4">
                        <h3 class="font-bold text-primary-700 mb-3 border-b pb-2">3. 醫療史</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                            ${data.historyCardio ? `<div><b>心血管:</b> ${translateMedical(data.historyCardio)}</div>` : ''}
                            ${data.historyMuscle ? `<div><b>肌肉骨骼:</b> ${translateMedical(data.historyMuscle)}</div>` : ''}
                            ${data.historyMetabolic ? `<div><b>代謝/血液:</b> ${translateMedical(data.historyMetabolic)}</div>` : ''}
                            ${data.historyKidney ? `<div><b>腎臟:</b> ${translateMedical(data.historyKidney)}</div>` : ''}
                            ${data.historyRespiratory ? `<div><b>呼吸:</b> ${translateMedical(data.historyRespiratory)}</div>` : ''}
                            ${data.historyAutoimmune ? `<div><b>自體免疫:</b> ${data.historyAutoimmune}</div>` : ''}
                            ${data.historyNeuro ? `<div><b>神經:</b> ${translateMedical(data.historyNeuro)}</div>` : ''}
                            ${data.historyGastro ? `<div><b>腸胃:</b> ${translateMedical(data.historyGastro)}</div>` : ''}
                            ${data.historyOtherPsych ? `<div><b>精神:</b> ${translateMedical(data.historyOtherPsych)}</div>` : ''}
                            ${data.historyOtherSleep ? `<div><b>睡眠:</b> ${translateMedical(data.historyOtherSleep)}</div>` : ''}
                        </div>
                        ${(!data.historyCardio && !data.historyMuscle && !data.historyMetabolic && !data.historyKidney && !data.historyRespiratory && !data.historyNeuro) ? '<div class="text-slate-400">無紀錄</div>' : ''}
                    </div>
                    
                    <!-- Section 4: Surgery/Medication/Allergy -->
                    <div class="border rounded-lg p-4">
                        <h3 class="font-bold text-primary-700 mb-3 border-b pb-2">4. 手術/藥物/過敏史</h3>
                        <div class="space-y-2">
                            <div><b>手術史:</b> ${data.surgeryHistory || '-'}</div>
                            <div><b>服藥史:</b> ${data.medicationHistory || '-'}</div>
                            <div><b>過敏史:</b> ${data.allergyHistory || '-'}</div>
                        </div>
                    </div>
                    
                    <!-- Section 5: Activity History -->
                    <div class="border rounded-lg p-4">
                        <h3 class="font-bold text-primary-700 mb-3 border-b pb-2">5. 身體活動史</h3>
                        <div class="space-y-2">
                            <div><b>診斷前活動量:</b> ${fmtActivity(data.preDxActivityLevel)}</div>
                            <div><b>偏好運動類型:</b> ${data.preferredExercise || '-'}</div>
                            <div><b>可用設備:</b> ${data.equipment || '-'}</div>
                        </div>
                    </div>
                    
                    <!-- Section 6: Personal Considerations -->
                    <div class="border rounded-lg p-4">
                        <h3 class="font-bold text-primary-700 mb-3 border-b pb-2">6. 個人化考量</h3>
                        <div class="space-y-2">
                            <div><b>運動目標:</b> ${data.goals || '-'}</div>
                            <div><b>限制:</b> ${data.limitations || '-'}</div>
                            <div><b>其他協助:</b> ${data.otherSupport || '-'}</div>
                        </div>
                    </div>
                    
                    <!-- Section 7: Cancer History (if applicable) -->
                    ${data.historyCancerFlag && data.historyCancerFlag.includes('Yes') ? `
                    <div class="border border-red-200 bg-red-50 rounded-lg p-4">
                        <h3 class="font-bold text-red-700 mb-3 border-b border-red-200 pb-2">7. 癌症病史</h3>
                        <div class="grid grid-cols-2 gap-2 mb-3">
                            <div><b>癌症類型:</b> ${data.cancerType || '-'}</div>
                            <div><b>癌症位置:</b> ${data.cancerLocation || '-'}</div>
                            <div><b>診斷日期:</b> ${fmtDate(data.cancerDxDate)}</div>
                            <div><b>轉移:</b> ${data.metastasis || '-'}</div>
                            <div class="col-span-2"><b>治療狀態:</b> ${fmtTxStatus(data.treatmentStatus)}</div>
                        </div>
                        <div class="space-y-1 border-t border-red-200 pt-2">
                            <div class="font-medium text-red-700 mb-1">已接受治療:</div>
                            ${data.txSurgery ? `<div>• <b>手術:</b> ${data.txSurgery}</div>` : ''}
                            ${data.txChemo ? `<div>• <b>化療:</b> ${data.txChemo}</div>` : ''}
                            ${data.txRadio ? `<div>• <b>放療:</b> ${data.txRadio}</div>` : ''}
                            ${data.txHormone ? `<div>• <b>荷爾蒙:</b> ${data.txHormone}</div>` : ''}
                            ${data.txTarget ? `<div>• <b>標靶:</b> ${data.txTarget}</div>` : ''}
                            ${data.txImmuno ? `<div>• <b>免疫:</b> ${data.txImmuno}</div>` : ''}
                            ${(!data.txSurgery && !data.txChemo && !data.txRadio && !data.txHormone && !data.txTarget && !data.txImmuno) ? '<div class="text-slate-400">無治療紀錄</div>' : ''}
                        </div>
                        ${data.cancerIssues ? `<div class="mt-2 border-t border-red-200 pt-2"><b>相關問題:</b> ${data.cancerIssues}</div>` : ''}
                    </div>
                    ` : ''}
                </div>
            `;
            panel.classList.remove('hidden');
        }

        function closeViewPanel() {
            document.getElementById('viewRecordPanel').classList.add('hidden');
        }

        function enterEditMode() {
            closeViewPanel();
            if (currentRecordData) {
                populateForm(currentRecordData);
                updateSubmitButton();
                switchTab('form');
                document.getElementById('main-scroll').scrollTo({ top: 0, behavior: 'smooth' });

                Swal.fire({
                    icon: 'info',
                    title: '已載入病人資料',
                    text: `正在編輯 ${currentRecordData.name || ''} 的評估紀錄`,
                    timer: 2000,
                    showConfirmButton: false
                });
            }
        }

        function updateSubmitButton() {
            const submitBtn = document.getElementById('submitBtn');
            const cancelBtn = document.getElementById('cancelEditBtn');

            if (currentRowId) { // Editing
                if (cancelBtn) cancelBtn.classList.remove('hidden');

                submitBtn.classList.remove('bg-slate-800', 'hover:bg-slate-900');
                submitBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                submitBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                    <span>更新紀錄</span>
                `;
            } else { // New Record
                if (cancelBtn) cancelBtn.classList.add('hidden');

                submitBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                submitBtn.classList.add('bg-slate-800', 'hover:bg-slate-900');
                submitBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                    </svg>
                    <span>提交紀錄</span>
                `;
            }
        }

        function populateForm(data) {
            const form = document.getElementById('assessmentForm');
            form.reset();

            // Date fields need special formatting for input[type="date"]
            const dateFields = ['date', 'dob', 'cancerDxDate'];

            // Simple text fields
            const textFields = ['name', 'phone', 'address', 'workStatus', 'maritalStatus',
                'alcohol', 'smoking', 'surgeryHistory', 'medicationHistory', 'allergyHistory',
                'preferredExercise', 'equipment', 'goals', 'otherSupport',
                'cancerType', 'cancerLocation', 'metastasis', 'historyAutoimmune'];

            // Handle date fields with formatting
            dateFields.forEach(field => {
                const el = form.querySelector(`[name="${field}"]`);
                if (el && data[field]) {
                    el.value = formatDateDisplay(data[field]);
                }
            });

            // Handle text fields directly
            textFields.forEach(field => {
                const el = form.querySelector(`[name="${field}"]`);
                if (el && data[field]) {
                    el.value = data[field];
                }
            });

            // Radio buttons (gender, activity levels, treatment status)
            const radioFields = ['gender', 'currentActivityLevel', 'preDxActivityLevel', 'treatmentStatus'];
            radioFields.forEach(field => {
                if (data[field]) {
                    const radio = form.querySelector(`input[name="${field}"][value="${data[field]}"]`);
                    if (radio) radio.checked = true;
                }
            });

            // Checkbox groups
            const checkboxFields = {
                'historyCardio': data.historyCardio,
                'historyMuscle': data.historyMuscle,
                'historyMetabolic': data.historyMetabolic,
                'historyKidney': data.historyKidney,
                'historyRespiratory': data.historyRespiratory,
                'historyNeuro': data.historyNeuro,
                'historyGastro': data.historyGastro,
                'historyOtherPsych': data.historyOtherPsych,
                'historyOtherSleep': data.historyOtherSleep,
                'limitations': data.limitations,
                'cancerIssues': data.cancerIssues
            };

            Object.entries(checkboxFields).forEach(([fieldName, valueString]) => {
                if (!valueString) return;
                const values = valueString.split(',').map(v => v.trim());
                values.forEach(val => {
                    let baseVal = val, textPart = '';
                    if (val.includes(':')) {
                        const idx = val.indexOf(':');
                        baseVal = val.substring(0, idx);
                        textPart = val.substring(idx + 1);
                    }
                    const cb = document.querySelector(`input[name="${fieldName}"][type="checkbox"][value="${baseVal}"]`);
                    if (cb) cb.checked = true;
                    if (textPart) {
                        const txt = document.querySelector(`input[name="${fieldName}"][type="text"][data-prefix="${baseVal}:"]`);
                        if (txt) txt.value = textPart;
                    }
                });
            });

            // Cancer flag
            if (data.historyCancerFlag && data.historyCancerFlag.includes('Yes')) {
                const cb = form.querySelector('input[name="historyCancerFlag"]');
                if (cb) cb.checked = true;
                toggleCancerSection(true);
            } else {
                toggleCancerSection(false);
            }

            // Autoimmune flag
            if (data.historyAutoimmune) {
                const flag = form.querySelector('input[name="historyAutoimmune_flag"]');
                if (flag) flag.checked = true;
            }

            // Cancer treatment fields - handle both legacy combined format and individual fields
            const txPrefixes = ['txSurgery', 'txChemo', 'txRadio', 'txHormone', 'txTarget', 'txImmuno'];
            txPrefixes.forEach(prefix => {
                // First try individual fields (new format)
                ['drug', 'type', 'date'].forEach(suffix => {
                    const fieldName = `${prefix}_${suffix}`;
                    const el = form.querySelector(`input[name="${fieldName}"]`);
                    if (el && data[fieldName]) {
                        el.value = data[fieldName];
                    }
                });
                // Toxicity radio
                if (data[`${prefix}_toxicity`] === 'Yes') {
                    const toxRadio = form.querySelector(`input[name="${prefix}_toxicity"][value="Yes"]`);
                    if (toxRadio) toxRadio.checked = true;
                }

                // Parse legacy combined format if individual fields not present
                // Format: "Type / Date (HeartTox: Yes)" or "TypeDrug / Date (HeartTox: Yes)"
                if (data[prefix] && !data[`${prefix}_type`] && !data[`${prefix}_drug`]) {
                    const combined = String(data[prefix]);
                    if (combined.trim()) {
                        // Check for HeartTox
                        const hasTox = combined.includes('(HeartTox: Yes)');
                        if (hasTox) {
                            const toxRadio = form.querySelector(`input[name="${prefix}_toxicity"][value="Yes"]`);
                            if (toxRadio) toxRadio.checked = true;
                        }

                        // Remove toxicity indicator and split by " / "
                        let cleanStr = combined.replace('(HeartTox: Yes)', '').replace('(HeartTox: No)', '').trim();
                        const parts = cleanStr.split(' / ').map(s => s.trim());

                        if (parts.length >= 1 && parts[0]) {
                            // For surgery, it goes to _type; for others to _drug or _type
                            const typeEl = form.querySelector(`input[name="${prefix}_type"]`);
                            const drugEl = form.querySelector(`input[name="${prefix}_drug"]`);
                            if (typeEl) typeEl.value = parts[0];
                            else if (drugEl) drugEl.value = parts[0];
                        }
                        if (parts.length >= 2 && parts[1]) {
                            const dateEl = form.querySelector(`input[name="${prefix}_date"]`);
                            if (dateEl) dateEl.value = parts[1];
                        }
                    }
                }
            });

            // Cancer side effects
            const sideEffectsEl = form.querySelector('textarea[name="cancerSideEffects"]');
            if (sideEffectsEl && data.cancerSideEffects) {
                sideEffectsEl.value = data.cancerSideEffects;
            }
        }

        function resetForm() {
            document.getElementById('assessmentForm').reset();
            currentRowId = null;
            updateButtonState();
            toggleCancerSection(false);
            document.getElementById('main-scroll').scrollTo({ top: 0, behavior: 'smooth' });
        }

        function updateButtonState() {
            const submitBtn = document.getElementById('submitBtn');
            const newBtn = document.getElementById('newRecordBtn');
            const printBtn = document.getElementById('editPrintBtn');

            if (currentRowId) {
                submitBtn.innerText = '更新資料';
                submitBtn.classList.remove('bg-primary-600', 'hover:bg-primary-700');
                submitBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                newBtn.classList.remove('hidden');
                printBtn.classList.remove('hidden');
            } else {
                submitBtn.innerText = '提交評估';
                submitBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                submitBtn.classList.add('bg-primary-600', 'hover:bg-primary-700');
                newBtn.classList.add('hidden');
                printBtn.classList.add('hidden');
            }
        }

        function collectFormData() {
            const form = document.getElementById('assessmentForm');
            const data = {};
            const formData = new FormData(form);

            // Simple fields
            ['date', 'name', 'dob', 'gender', 'phone', 'address', 'workStatus', 'maritalStatus',
                'alcohol', 'smoking', 'currentActivityLevel', 'surgeryHistory', 'medicationHistory',
                'allergyHistory', 'preDxActivityLevel', 'preferredExercise', 'equipment', 'goals',
                'otherSupport', 'cancerType', 'cancerLocation', 'cancerDxDate', 'metastasis',
                'treatmentStatus'].forEach(key => {
                    data[key] = formData.get(key) || '';
                });

            // Complex Checkbox Groups (join with comma, handling "Other" inputs)
            const collectChecks = (name) => {
                const values = [];
                // Standard checkboxes
                document.querySelectorAll(`input[name="${name}"]:checked`).forEach(el => {
                    if (el.type === 'text') return; // skip inputs handled below
                    values.push(el.value);
                });
                // Text inputs attached to this group name (e.g., "Other: ...")
                document.querySelectorAll(`input[name="${name}"][type="text"]`).forEach(el => {
                    if (el.value.trim()) {
                        const prefix = el.getAttribute('data-prefix') || '';
                        values.push(prefix + el.value.trim());
                    }
                });
                return values.join(', ');
            };

            data.historyCardio = collectChecks('historyCardio');
            data.historyMuscle = collectChecks('historyMuscle');
            data.historyMetabolic = collectChecks('historyMetabolic');
            data.historyKidney = collectChecks('historyKidney');
            data.historyRespiratory = collectChecks('historyRespiratory');
            data.historyNeuro = collectChecks('historyNeuro');
            data.historyGastro = collectChecks('historyGastro');
            data.historyOtherPsych = collectChecks('historyOtherPsych');
            data.historyOtherSleep = collectChecks('historyOtherSleep');
            data.historyCancerFlag = collectChecks('historyCancerFlag');

            data.historyAutoimmune = document.querySelector('input[name="historyAutoimmune"]').value;

            data.limitations = collectChecks('limitations');
            data.cancerIssues = collectChecks('cancerIssues');

            // Cancer treatment fields - save individually for proper read/write
            const txPrefixes = ['txSurgery', 'txChemo', 'txRadio', 'txHormone', 'txTarget', 'txImmuno'];
            txPrefixes.forEach(prefix => {
                const drugEl = document.querySelector(`input[name="${prefix}_drug"]`);
                const typeEl = document.querySelector(`input[name="${prefix}_type"]`);
                const dateEl = document.querySelector(`input[name="${prefix}_date"]`);
                const toxYesEl = document.querySelector(`input[name="${prefix}_toxicity"][value="Yes"]`);

                if (drugEl) data[`${prefix}_drug`] = drugEl.value || '';
                if (typeEl) data[`${prefix}_type`] = typeEl.value || '';
                if (dateEl) data[`${prefix}_date`] = dateEl.value || '';
                if (toxYesEl) data[`${prefix}_toxicity`] = toxYesEl.checked ? 'Yes' : 'No';
            });

            // Cancer side effects
            const sideEffectsEl = document.querySelector('textarea[name="cancerSideEffects"]');
            if (sideEffectsEl) data.cancerSideEffects = sideEffectsEl.value || '';

            return data;
        }

        function submitForm() {
            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.innerText;
            submitBtn.innerText = currentRowId ? '更新中...' : '提交中...';
            submitBtn.disabled = true;

            const data = collectFormData();

            if (!data.name || !data.date) {
                Swal.fire('Error', '請至少填寫姓名與日期', 'error');
                submitBtn.innerText = originalText;
                submitBtn.disabled = false;
                return;
            }

            // Add action and rowId for update
            if (currentRowId) {
                data.action = 'update';
                data.rowId = currentRowId;
            }

            fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: new URLSearchParams(data)
            }).then(() => {
                const msg = currentRowId ? '資料已更新成功' : '評估表已提交成功';
                Swal.fire('Success', msg, 'success').then(() => {
                    if (!currentRowId) {
                        document.getElementById('assessmentForm').reset();
                        toggleCancerSection(false);
                    }
                });
            }).catch(err => {
                console.error(err);
                Swal.fire('Error', '提交失敗，請檢查網路或是聯繫管理員', 'error');
            }).finally(() => {
                submitBtn.innerText = originalText;
                submitBtn.disabled = false;
                updateButtonState();
            });
        }

        // ========== Print Function ==========
        function printRecord() {
            if (!currentRecordData) return;
            const item = currentRecordData;

            const printWindow = window.open('', '_blank');
            const v = (val) => String(val || '').replace(/\n/g, '<br>');
            const fmtDate = (d) => v(formatDateDisplay(d)).replace(/-/g, '/');
            const fmtGender = (g) => g === 'Male' ? '男' : g === 'Female' ? '女' : '';
            const fmtActivity = (l) => ({
                'Sedentary': '久坐', 'Light': '輕度', 'Moderate': '中度',
                'High': '高度', 'VeryHigh': '極高'
            })[l] || l || '';

            const html = `
                <!DOCTYPE html>
                <html lang="zh-TW">
                <head>
                    <meta charset="UTF-8">
                    <title>列印評估紀錄 - ${v(item.name)}</title>
                    <style>
                        @page { size: A4 portrait; margin: 10mm; }
                        body { 
                            font-family: "BiauKai", "DFKai-SB", "標楷體", serif !important; 
                            margin: 0; padding: 0; 
                            color: #333; font-size: 10pt; line-height: 1.5;
                            background: #fff;
                        }
                        * { box-sizing: border-box; font-family: "BiauKai", "DFKai-SB", "標楷體", serif !important; }
                        
                        .container { width: 100%; max-width: 190mm; margin: 0 auto; }
                        
                        /* Header */
                        header {
                            text-align: center;
                            margin-bottom: 12px;
                            border-bottom: 2px double #333;
                            padding-bottom: 8px;
                        }
                        h1 { margin: 0; font-size: 16pt; font-weight: 900; letter-spacing: 2px; }
                        .subtitle { font-size: 9pt; margin-top: 4px; color: #666; }

                        /* Grid */
                        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; align-items: start; }
                        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
                        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
                        
                        /* Section */
                        .section {
                            border: 1.5px solid #333;
                            border-radius: 5px;
                            padding: 12px;
                            position: relative;
                            background: #fff;
                            page-break-inside: avoid;
                        }
                        .section-title {
                            position: absolute;
                            top: -10px;
                            left: 12px;
                            background: #fff;
                            padding: 0 6px;
                            font-size: 10pt;
                            font-weight: bold;
                            color: #000;
                        }

                        /* Fields */
                        .field { margin-bottom: 6px; line-height: 1.5; }
                        .field.inline { display: flex; align-items: baseline; }
                        .label { font-size: 9pt; color: #555; font-weight: bold; margin-right: 6px; white-space: nowrap; }
                        .value { font-size: 10pt; color: #000; font-weight: 500; border-bottom: 1px dotted #ccc; padding-bottom: 1px; flex: 1; }
                        .value.no-border { border-bottom: none; }
                        .value-block { display: block; margin-top: 3px; padding: 6px; background: #f8f9fa; border-radius: 4px; font-size: 9pt; line-height: 1.5; }

                        /* Checklist */
                        .checklist { display: grid; grid-template-columns: 1fr; gap: 4px; font-size: 9pt; }
                        .checklist-item { display: flex; align-items: flex-start; }
                        .bullet { margin-right: 3px; font-weight: bold; white-space: nowrap; }

                        /* Footer */
                        footer { margin-top: 12px; text-align: right; font-size: 8pt; color: #888; border-top: 1px solid #eee; padding-top: 6px; }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <header>
                            <h1>運動參與前評估暨篩檢量表</h1>
                            <div class="subtitle">Personalized Exercise Assessment Record</div>
                        </header>

                        <!-- Row 1: Basic & Social -->
                        <div class="grid-2">
                            <div class="section">
                                <div class="section-title">01 基本資料</div>
                                <div class="grid-2" style="gap: 6px; margin-bottom: 0;">
                                    <div class="field inline" style="grid-column: span 2;">
                                        <span class="label">評估日期</span>
                                        <span class="value">${fmtDate(item.date)}</span>
                                    </div>
                                    <div class="field inline">
                                        <span class="label">姓名</span>
                                        <span class="value">${v(item.name)}</span>
                                    </div>
                                    <div class="field inline">
                                        <span class="label">性別</span>
                                        <span class="value">${fmtGender(item.gender)}</span>
                                    </div>
                                    <div class="field inline">
                                        <span class="label">出生日期</span>
                                        <span class="value">${fmtDate(item.dob)}</span>
                                    </div>
                                    <div class="field inline">
                                        <span class="label">電話</span>
                                        <span class="value">${v(item.phone)}</span>
                                    </div>
                                </div>
                                <div class="field inline" style="margin-top: 6px;">
                                    <span class="label">地址</span>
                                    <span class="value">${v(item.address)}</span>
                                </div>
                            </div>

                            <div class="section">
                                <div class="section-title">02 社會背景</div>
                                <div class="grid-2" style="gap: 6px; margin-bottom: 0;">
                                    <div class="field">
                                        <span class="label">工作狀態</span>
                                        <div class="value no-border">${v(item.workStatus)}</div>
                                    </div>
                                    <div class="field">
                                        <span class="label">婚姻狀況</span>
                                        <div class="value no-border">${v(item.maritalStatus)}</div>
                                    </div>
                                    <div class="field">
                                        <span class="label">飲酒</span>
                                        <div class="value no-border">${v(item.alcohol)}</div>
                                    </div>
                                    <div class="field">
                                        <span class="label">抽菸</span>
                                        <div class="value no-border">${v(item.smoking)}</div>
                                    </div>
                                </div>
                                <div style="margin-top: 8px; padding: 6px; background: #f0f0f0; border-radius: 4px; text-align: center;">
                                    <span class="label">當前活動量</span>
                                    <div style="font-size: 11pt; font-weight: bold; margin-top: 2px;">${fmtActivity(item.currentActivityLevel)}</div>
                                </div>
                            </div>
                        </div>

                        <!-- Row 2: Medical & Surgery -->
                        <div class="grid-2">
                            <div class="section">
                                <div class="section-title">03 醫療病史 (系統回顧)</div>
                                <div class="checklist">
                                    <div class="checklist-item"><span class="bullet">心血管:</span> <span>${translateMedical(item.historyCardio)}</span></div>
                                    <div class="checklist-item"><span class="bullet">肌肉骨骼:</span> <span>${translateMedical(item.historyMuscle)}</span></div>
                                    <div class="checklist-item"><span class="bullet">代謝/血液:</span> <span>${translateMedical(item.historyMetabolic)}</span></div>
                                    <div class="checklist-item"><span class="bullet">腎臟:</span> <span>${translateMedical(item.historyKidney)}</span></div>
                                    <div class="checklist-item"><span class="bullet">呼吸:</span> <span>${translateMedical(item.historyRespiratory)}</span></div>
                                    <div class="checklist-item"><span class="bullet">神經:</span> <span>${translateMedical(item.historyNeuro)}</span></div>
                                    <div class="checklist-item"><span class="bullet">自體免疫:</span> <span>${v(item.historyAutoimmune) || '-'}</span></div>
                                    <div class="checklist-item"><span class="bullet">腸胃:</span> <span>${translateMedical(item.historyGastro)}</span></div>
                                    <div class="checklist-item"><span class="bullet">其他:</span> <span>${[translateMedical(item.historyOtherPsych), translateMedical(item.historyOtherSleep)].filter(Boolean).join(', ') || '-'}</span></div>
                                </div>
                            </div>

                            <div class="section">
                                <div class="section-title">04 手術/藥物/過敏史</div>
                                <div class="field">
                                    <span class="label">手術史</span>
                                    <span class="value-block">${v(item.surgeryHistory) || '無'}</span>
                                </div>
                                <div class="field">
                                    <span class="label">長期用藥</span>
                                    <span class="value-block">${v(item.medicationHistory) || '無'}</span>
                                </div>
                                <div class="field">
                                    <span class="label">過敏紀錄</span>
                                    <span class="value-block">${v(item.allergyHistory) || '無'}</span>
                                </div>
                            </div>
                        </div>

                        <!-- Row 3: Activity & Personal -->
                        <div class="grid-2">
                            <div class="section">
                                <div class="section-title">05 身體活動史</div>
                                <div class="field inline">
                                    <span class="label">診斷前活動量</span>
                                    <span class="value">${fmtActivity(item.preDxActivityLevel)}</span>
                                </div>
                                <div class="field" style="margin-top: 8px;">
                                    <span class="label">偏好運動類型</span>
                                    <div class="value-block">${v(item.preferredExercise) || '-'}</div>
                                </div>
                                <div class="field">
                                    <span class="label">現有設備</span>
                                    <div class="value-block">${v(item.equipment) || '-'}</div>
                                </div>
                            </div>

                            <div class="section">
                                <div class="section-title">06 個人化考量</div>
                                <div class="field">
                                    <span class="label">運動目標</span>
                                    <div class="value-block">${v(item.goals) || '-'}</div>
                                </div>
                                <div class="field">
                                    <span class="label">主要限制</span>
                                    <div class="value-block">${v(item.limitations) || '-'}</div>
                                </div>
                                <div class="field">
                                    <span class="label">其他需求</span>
                                    <div class="value-block">${v(item.otherSupport) || '-'}</div>
                                </div>
                            </div>
                        </div>

                        <!-- Cancer Section -->
                        ${(item.historyCancerFlag && item.historyCancerFlag.includes('Yes')) ? `
                        <div class="section" style="border-color: #dc2626;">
                            <div class="section-title" style="color: #dc2626;">07 癌症病史</div>
                            <div class="grid-4" style="margin-bottom: 10px;">
                                <div class="field">
                                    <span class="label">癌症種類</span>
                                    <div class="value no-border">${v(item.cancerType)}</div>
                                </div>
                                <div class="field">
                                    <span class="label">位置</span>
                                    <div class="value no-border">${v(item.cancerLocation)}</div>
                                </div>
                                <div class="field">
                                    <span class="label">診斷日期</span>
                                    <div class="value no-border">${fmtDate(item.cancerDxDate)}</div>
                                </div>
                                <div class="field">
                                    <span class="label">轉移狀況</span>
                                    <div class="value no-border">${v(item.metastasis)}</div>
                                </div>
                            </div>
                            <div style="border-top: 1px dashed #dc2626; padding-top: 10px;">
                                <div class="field" style="margin-bottom: 8px;">
                                    <span class="label">治療狀態</span>
                                    <div class="value-block" style="background:#fef2f2;">${v(item.treatmentStatus) === 'ActiveSurveillance' ? '追蹤中' : v(item.treatmentStatus) === 'OnTreatment' ? '治療中' : v(item.treatmentStatus) === 'Completed' ? '已完成治療' : v(item.treatmentStatus) || '-'}</div>
                                </div>
                                <div class="field">
                                    <span class="label">已接受之治療</span>
                                    <div class="value-block" style="background:#fef2f2; padding: 8px;">
                                        ${(() => {
                        // Helper to remove English HeartTox text from legacy strings
                        const cleanTx = (val) => String(val || '').replace(/\(HeartTox: (Yes|No)\)/g, '').trim();
                        return `
                                        ${(item.txSurgery_type || item.txSurgery) ? '<div style="margin-bottom:4px;"><strong>手術:</strong> ' + cleanTx(item.txSurgery_type || item.txSurgery) + (item.txSurgery_date ? ' (' + fmtDate(item.txSurgery_date) + ')' : '') + '</div>' : ''}
                                        ${(item.txChemo_drug || item.txChemo) ? '<div style="margin-bottom:4px;"><strong>化學治療:</strong> ' + cleanTx(item.txChemo_drug || item.txChemo) + (item.txChemo_date ? ' (' + v(item.txChemo_date) + ')' : '') + (item.txChemo_toxicity === 'Yes' || (item.txChemo && String(item.txChemo).includes('HeartTox: Yes')) ? ' <span style="color:#dc2626;">[心臟毒性:是]</span>' : '') + '</div>' : ''}
                                        ${(item.txRadio_type || item.txRadio) ? '<div style="margin-bottom:4px;"><strong>放射治療:</strong> ' + cleanTx(item.txRadio_type || item.txRadio) + (item.txRadio_date ? ' (' + v(item.txRadio_date) + ')' : '') + (item.txRadio_toxicity === 'Yes' || (item.txRadio && String(item.txRadio).includes('HeartTox: Yes')) ? ' <span style="color:#dc2626;">[心臟毒性:是]</span>' : '') + '</div>' : ''}
                                        ${(item.txHormone_drug || item.txHormone) ? '<div style="margin-bottom:4px;"><strong>賀爾蒙治療:</strong> ' + cleanTx(item.txHormone_drug || item.txHormone) + (item.txHormone_date ? ' (' + v(item.txHormone_date) + ')' : '') + (item.txHormone_toxicity === 'Yes' || (item.txHormone && String(item.txHormone).includes('HeartTox: Yes')) ? ' <span style="color:#dc2626;">[心臟毒性:是]</span>' : '') + '</div>' : ''}
                                        ${(item.txTarget_drug || item.txTarget) ? '<div style="margin-bottom:4px;"><strong>標靶治療:</strong> ' + cleanTx(item.txTarget_drug || item.txTarget) + (item.txTarget_date ? ' (' + v(item.txTarget_date) + ')' : '') + (item.txTarget_toxicity === 'Yes' || (item.txTarget && String(item.txTarget).includes('HeartTox: Yes')) ? ' <span style="color:#dc2626;">[心臟毒性:是]</span>' : '') + '</div>' : ''}
                                        ${(item.txImmuno_drug || item.txImmuno) ? '<div style="margin-bottom:4px;"><strong>免疫治療:</strong> ' + cleanTx(item.txImmuno_drug || item.txImmuno) + (item.txImmuno_date ? ' (' + v(item.txImmuno_date) + ')' : '') + (item.txImmuno_toxicity === 'Yes' || (item.txImmuno && String(item.txImmuno).includes('HeartTox: Yes')) ? ' <span style="color:#dc2626;">[心臟毒性:是]</span>' : '') + '</div>' : ''}
                                        ${!(item.txSurgery_type || item.txSurgery) && !(item.txChemo_drug || item.txChemo) && !(item.txRadio_type || item.txRadio) && !(item.txHormone_drug || item.txHormone) && !(item.txTarget_drug || item.txTarget) && !(item.txImmuno_drug || item.txImmuno) ? '無紀錄' : ''}
                                            `;
                    })()}
                                    </div>
                                </div>
                                ${item.cancerSideEffects ? `
                                <div style="margin-top: 8px;">
                                    <span class="label">治療相關之副作用</span>
                                    <div class="value-block" style="background:#fef2f2;">${v(item.cancerSideEffects)}</div>
                                </div>` : ''}
                                ${item.cancerIssues ? `
                                <div style="margin-top: 8px;">
                                    <span class="label">運動相關症狀</span>
                                    <div class="value-block" style="background:#fef2f2;">${v(item.cancerIssues)}</div>
                                </div>` : ''}
                            </div>
                        </div>
                        ` : ''}
                        
                        <footer>
                            列印日期: ${new Date().toLocaleDateString()} | Page 1 of 1
                        </footer>
                    </div>
                </body>
                </html>
            `;

            printWindow.document.write(html);
            printWindow.document.close();
            setTimeout(() => {
                printWindow.focus();
                printWindow.print();
            }, 500);
        }

    </script>
</body>

</html>
